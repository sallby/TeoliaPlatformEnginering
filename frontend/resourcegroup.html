<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Groups</title>
</head>

<body>
    <h1>Resource Groups</h1>
    <table border="1">
        <thead>
            <tr>
                <th>Name</th>
                <th>Location</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="resourceGroupTableBody"></tbody>
    </table>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const subscriptionId = "319819ff-ed9b-4c33-a3d3-d7833a1a5a54";
        const apiEndpoint = "https://management.azure.com/subscriptions/" + subscriptionId + "/resourcegroups?api-version=2021-04-01";

        async function getResourceGroups() {
            try {
                const tokenResponse = await axios.post('/api/getTokenFromAAD');
                const token = tokenResponse.data.access_token;

                const response = await axios.get(apiEndpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });

                const resourceGroups = response.data.value;
                const tableBody = document.getElementById("resourceGroupTableBody");

                resourceGroups.forEach(group => {
                    const row = document.createElement("tr");
                    const nameCell = document.createElement("td");
                    const locationCell = document.createElement("td");
                    const actionCell = document.createElement("td");

                    nameCell.textContent = group.name;
                    locationCell.textContent = group.location;
                    actionCell.innerHTML = `<button onclick="deleteResourceGroup('${group.name}')">Supprimer</button>`;

                    row.appendChild(nameCell);
                    row.appendChild(locationCell);
                    row.appendChild(actionCell);
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error("Error fetching resource groups:", error);
            }
        }
        async function deleteResourceGroup(resourceName) {
            try {
                // Find the table row associated with the clicked button
                const button = event.target;
                const tableRow = button.parentNode.parentNode;

                // Extract the location from the corresponding location cell
                const locationCell = tableRow.cells[1];
                const location = locationCell.textContent;

                // Create the data object for the JSON body
                const data = {
                    localisation: location,
                    nomRessource: resourceName,
                };

                const url = '/api/delete_ressource'; // Assuming your Azure function is at this endpoint
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data), // Send the data object as JSON body
                });

                if (!response.ok) {
                    throw new Error(`Erreur lors de la requête: ${response.status} ${response.statusText}`);
                }

                alert(`Le groupe de ressources "${resourceName}" a été supprimé avec succès.`);
                // Actualisez la liste des groupes de ressources après la suppression
                getResourceGroups();
            } catch (error) {
                console.error("Error deleting resource group:", error);
            }
        }

        getResourceGroups();
    </script>
</body>

</html>